#include <behaviors.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/ext_power.h>
#include <dt-bindings/zmk/mouse.h>
#include <dt-bindings/zmk/outputs.h>

/* Base */
#define b 0
/* Navigation */
#define n 1
/* Symbols */
#define s 2
/* Numbers */
#define u 3

&sl {
  release-after-ms = <250>;
};

&mt {
    tapping-term-ms = <200>;
    require-prior-idle-ms = <150>;
};

/ {
    trackball_listener {
        compatible = "zmk,input-behavior-listener";
        device = <&vtrackball>;
        layers = <b u>;
        evt-type = <INPUT_EV_REL>;
        x-input-code = <INPUT_REL_X>;
        y-input-code = <INPUT_REL_Y>;
        scale-multiplier = <1>;
        scale-divisor = <4>;
    };

    trackball_snipe_listener {
        compatible = "zmk,input-behavior-listener";   
        device = <&vtrackball>;
        layers = <s>;
        evt-type = <INPUT_EV_REL>;
        x-input-code = <INPUT_REL_X>;
        y-input-code = <INPUT_REL_Y>;
        scale-multiplier = <1>;
        scale-divisor = <12>;
    };

    trackball_scroll_listener {
        compatible = "zmk,input-behavior-listener";
        device = <&vtrackball>;
        layers = <n>;
        evt-type = <INPUT_EV_REL>;
        x-input-code = <INPUT_REL_MISC>;
        y-input-code = <INPUT_REL_WHEEL>;
        y-invert;
        scale-divisor = <6>;
        bindings = <&ib_wheel_scaler 1 8>;
    };

    ib_wheel_scaler: ib_wheel_scaler {
        compatible = "zmk,input-behavior-scaler";
        #binding-cells = <2>;
        evt-type = <INPUT_EV_REL>;
        input-code = <INPUT_REL_WHEEL>;
    };

    behaviors {
        ltn: layer_tap_none {
            compatible = "zmk,behavior-hold-tap";
            label = "LAYER_TAP_NONE";
            bindings = <&mo>, <&none>;

            #binding-cells = <2>;
            tapping-term-ms = <280>;
            hold-trigger-key-positions = <5 6 7 8 9 15 16 17 18 19 25 26 27 28 29 33 34>;
            flavor = "balanced";
            quick-tap-ms = <175>;
            require-prior-idle-ms = <125>;
            hold-trigger-on-release;
        };

        hl: homewrow_mods_left {
            compatible = "zmk,behavior-hold-tap";
            label = "HOMEROW_MODS_LEFT_HAND";
            bindings = <&kp>, <&kp>;

            #binding-cells = <2>;
            tapping-term-ms = <280>;
            hold-trigger-key-positions = <5 6 7 8 9 15 16 17 18 19 25 26 27 28 29 33 34>;
            flavor = "balanced";
            quick-tap-ms = <175>;
            require-prior-idle-ms = <125>;
            hold-trigger-on-release;
        };

        hr: homewrow_mods_right {
            compatible = "zmk,behavior-hold-tap";
            label = "HOMEROW_MODS_RIGHT_HAND";
            bindings = <&kp>, <&kp>;

            #binding-cells = <2>;
            tapping-term-ms = <280>;
            hold-trigger-key-positions = <0 1 2 3 4 10 11 12 13 14 20 21 22 23 24 30 31 32>;
            flavor = "balanced";
            quick-tap-ms = <175>;
            require-prior-idle-ms = <125>;
            hold-trigger-on-release;
        };
    };

    chosen {
        zmk,matrix_transform = &five_column_transform;
    };

    combos {
        compatible = "zmk,combos";
        combo_esc { timeout-ms = <35>; key-positions = <22 23>; bindings = <&kp ESCAPE>; require-prior-idle-ms = <150>; layers = <b>; };

        combo_lbkt { timeout-ms = <45>; key-positions = <1 11>; bindings = <&kp LBKT>; require-prior-idle-ms = <150>; layers = <b>; };
        combo_lpar { timeout-ms = <45>; key-positions = <2 12>; bindings = <&kp LPAR>; require-prior-idle-ms = <150>; layers = <b>; };
        combo_lbrc { timeout-ms = <45>; key-positions = <3 13>; bindings = <&kp LBRC>; require-prior-idle-ms = <150>; layers = <b>; };
        combo_lt { timeout-ms = <45>; key-positions = <4 14>; bindings = <&kp LT>; require-prior-idle-ms = <150>; layers = <b>; };

        combo_gt { timeout-ms = <45>; key-positions = <5 15>; bindings = <&kp GT>; require-prior-idle-ms = <150>; layers = <b>; };
        combo_rbrc { timeout-ms = <45>; key-positions = <6 16>; bindings = <&kp RBRC>; require-prior-idle-ms = <150>; layers = <b>; };
        combo_rpar { timeout-ms = <45>; key-positions = <7 17>; bindings = <&kp RPAR>; require-prior-idle-ms = <150>; layers = <b>; };
        combo_rbkt { timeout-ms = <45>; key-positions = <8 18>; bindings = <&kp RBKT>; require-prior-idle-ms = <150>; layers = <b>; };

        combo_rl_leftclk { timeout-ms = <40>; key-positions = <17 18>; bindings = <&mkp LCLK>; require-prior-idle-ms = <150>; layers = <b n s u>; };
        combo_rl_middleclk { timeout-ms = <40>; key-positions = <17 27>; bindings = <&mkp MCLK>; require-prior-idle-ms = <150>; layers = <b n s u>; };
        combo_rl_rightclk { timeout-ms = <40>; key-positions = <18 28>; bindings = <&mkp RCLK>; require-prior-idle-ms = <150>; layers = <b n s u>; };

        combo_capsword { timeout-ms = <40>; key-positions = <2 7>; bindings = <&caps_word>; require-prior-idle-ms = <150>; layers = <b>; };
        combo_capslock { timeout-ms = <40>; key-positions = <1 8>; bindings = <&kp CAPS>; require-prior-idle-ms = <150>; layers = <b>; };
    };

    keymap {
        compatible = "zmk,keymap";

        Base {
            bindings = <
                &kp Q      &kp W      &kp E       &kp R        &kp T     &kp Y       &kp U       &kp I       &kp O      &kp P
                &hl LGUI A &hl LALT S &hl LCTRL D &hl LSHIFT F &kp G     &kp H       &hr RSHFT J &hr RCTRL K &hr RALT L &hr RGUI SEMICOLON
                &kp Z      &kp X      &kp C       &kp V        &kp B     &kp N       &kp M       &kp COMMA   &kp DOT    &kp SLASH
                                      &lt s SQT   &lt n SPACE  &lt u TAB &lt u ENTER &ltn s s
            >;
        };

        Navigation {
            bindings = <
                &trans        &trans     &trans       &trans       &trans     &trans            &trans        &trans      &trans    &trans
                &kp C_MUTE    &kp C_PREV &kp C_VOL_DN &kp C_VOL_UP &kp C_NEXT &kp LEFT          &kp DOWN      &kp UP      &kp RIGHT &trans
                &trans        &trans     &trans       &trans       &trans     &kp HOME          &kp PAGE_DOWN &kp PAGE_UP &kp END   &trans
                              &trans     &trans       &trans       &kp C_STOP &kp C_PLAY_PAUSE
            >;
        };

        Symbols {
            bindings = <
                &kp CARET     &kp AMPS &kp STAR  &kp TILDE &kp PLUS  &kp PLUS  &kp AMPS  &kp STAR  &kp GRAVE &kp CARET
                &kp PIPE      &kp DLLR &kp PRCNT &kp EQUAL &kp MINUS &kp MINUS &kp DLLR  &kp PRCNT &kp EQUAL &kp BSPC
                &kp BACKSLASH &kp EXCL &kp AT    &kp HASH  &kp UNDER &kp UNDER &kp EXCL  &kp AT    &kp HASH  &kp BACKSLASH
                                       &kp GRAVE &kp TILDE &trans    &kp TILDE &kp GRAVE
            >;
        };

        Numbers {
            bindings = <
                &trans &kp N7 &kp N8 &kp N9 &trans &trans &kp N7 &kp N8 &kp N9 &trans
                &kp N0 &kp N4 &kp N5 &kp N6 &trans &trans &kp N4 &kp N5 &kp N6 &kp N0
                &trans &kp N1 &kp N2 &kp N3 &trans &trans &kp N1 &kp N2 &kp N3 &trans
                              &trans &trans &trans &trans &trans
            >;
        };
    };
};
